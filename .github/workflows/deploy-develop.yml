name: Deploy to Test Server (Develop)

# Trigger workflow on push to develop branch
on:
  push:
    branches:
      - develop

jobs:
  deploy:
    name: Trigger Deployment via Webhook
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Send deployment webhook
        env:
          WEBHOOK_URL: ${{ secrets.DEPLOY_WEBHOOK_URL }}
          WEBHOOK_SECRET: ${{ secrets.DEPLOY_WEBHOOK_SECRET }}
        run: |
          # Generate timestamp
          TIMESTAMP=$(date +%s)
          
          # Safely escape commit message for JSON
          # Use jq if available, otherwise use basic escaping
          COMMIT_MSG='${{ github.event.head_commit.message }}'
          if command -v jq >/dev/null 2>&1; then
            COMMIT_MSG_JSON=$(echo "$COMMIT_MSG" | jq -Rs .)
          else
            # Basic JSON escaping: escape backslashes, quotes, newlines
            COMMIT_MSG_JSON=$(echo "$COMMIT_MSG" | sed 's/\\/\\\\/g; s/"/\\"/g' | awk '{printf "%s\\n", $0}' | sed 's/\\n$//')
            COMMIT_MSG_JSON="\"$COMMIT_MSG_JSON\""
          fi
          
          # Create payload
          PAYLOAD=$(cat <<EOF
          {
            "ref": "${{ github.ref }}",
            "repository": "${{ github.repository }}",
            "commit": "${{ github.sha }}",
            "commit_message": $COMMIT_MSG_JSON,
            "pusher": "${{ github.actor }}",
            "timestamp": $TIMESTAMP
          }
          EOF
          )
          
          # Generate signature using HMAC-SHA256
          SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" | sed 's/^.* //')
          
          # Send webhook request
          HTTP_CODE=$(curl -s -o /tmp/webhook-response.txt -w "%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "X-Hub-Signature-256: sha256=$SIGNATURE" \
            -H "X-GitHub-Event: push" \
            -H "User-Agent: GitHub-Actions-Deploy" \
            --data "$PAYLOAD" \
            "$WEBHOOK_URL")
          
          echo "Webhook response code: $HTTP_CODE"
          echo "Response body:"
          cat /tmp/webhook-response.txt
          
          # Check if request was successful
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "✅ Deployment webhook triggered successfully!"
          else
            echo "❌ Deployment webhook failed with status code: $HTTP_CODE"
            exit 1
          fi

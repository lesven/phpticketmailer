services:
  # PHP-FPM Service mit den n√∂tigen PHP-Extensions
  php:
    # Verwende nur die Build-Konfiguration
    container_name: ticketumfrage_php
    volumes:
      - .:/var/www/html
    depends_on:
      - database
    environment:
      - APP_ENV=dev
      - DATABASE_URL=mysql://ticketuser:ticketpassword@database:3306/ticket_mailer_db?serverVersion=mariadb-10.5&charset=utf8mb4
    networks:
      - ticketumfrage_network
    build:
      context: .
      dockerfile: docker/php/Dockerfile
      args:
        DOCKER_PLATFORM: ${DOCKER_PLATFORM:-linux/amd64}
    restart: unless-stopped

  # Nginx Webserver
  webserver:
    build:
      context: ./docker/nginx
      dockerfile: Dockerfile
      args:
        DOCKER_PLATFORM: ${DOCKER_PLATFORM:-linux/amd64}
    container_name: ticketumfrage_webserver
    #ports:
    #  - "8080:80"
    volumes:
      - .:/var/www/html
      - ./docker/nginx/conf.d:/etc/nginx/conf.d
    depends_on:
      - php
    networks:
      - ticketumfrage_network
    restart: unless-stopped

  # MariaDB 10.5 Datenbank (ARM-kompatibel)
  database:
    build:
      context: ./docker/mysql
      dockerfile: Dockerfile
    container_name: ticketumfrage_database
    restart: unless-stopped
    environment:
      # Bitnami MariaDB Umgebungsvariablen
      MARIADB_DATABASE: ticket_mailer_db
      MARIADB_USER: ticketuser
      MARIADB_PASSWORD: ticketpassword
      MARIADB_ROOT_PASSWORD: rootpassword
      ALLOW_EMPTY_PASSWORD: no
    volumes:
      - dbdata:/bitnami/mariadb
    networks:
      - ticketumfrage_network
    ports:
      - "3306:3306"

  # Einfaches SMTP-Testing mit einfacherem Docker-Image
  mailserver:
    image: namshi/smtp
    container_name: ticketumfrage_mailserver
    ports:
      - "1025:25"
    networks:
      - ticketumfrage_network
    restart: unless-stopped

# Docker Networks
networks:
  ticketumfrage_network:
    driver: bridge

# Docker Volumes
volumes:
  dbdata:
    driver: local
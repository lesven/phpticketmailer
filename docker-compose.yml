services:
  # PHP-FPM Service mit den n√∂tigen PHP-Extensions
  php:
    container_name: ticketumfrage_php
    build:
      context: .
      dockerfile: docker/php/Dockerfile
      args:
        DOCKER_PLATFORM: ${DOCKER_PLATFORM:-linux/amd64}
    volumes:
      - .:/var/www/html
    depends_on:
      - database
    environment:
      - APP_ENV=dev
      - DATABASE_URL=mysql://ticketuser:ticketpassword@database:3306/ticket_mailer_db?serverVersion=mariadb-10&charset=utf8mb4
    networks:
      - ticketumfrage_network
    restart: unless-stopped

  # Nginx Webserver
  webserver:
    build:
      context: ./docker/nginx
      dockerfile: Dockerfile
      args:
        DOCKER_PLATFORM: ${DOCKER_PLATFORM:-linux/amd64}
    container_name: ticketumfrage_webserver
    volumes:
      - .:/var/www/html
      - ./docker/nginx/conf.d:/etc/nginx/conf.d
    depends_on:
      - php
    networks:
      - ticketumfrage_network
    restart: unless-stopped

  # MariaDB Datenbank (ARM-kompatibel)
  database:
    image: mariadb
    container_name: ticketumfrage_database
    restart: unless-stopped
    environment:
      - MYSQL_DATABASE=ticket_mailer_db
      - MYSQL_USER=ticketuser
      - MYSQL_PASSWORD=ticketpassword
      - MYSQL_ROOT_PASSWORD=rootpassword
    volumes:
      - dbdata:/var/lib/mysql
    command: --bind-address=0.0.0.0
    networks:
      - ticketumfrage_network
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD", "pgrep", "mariadbd"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Einfaches SMTP-Testing mit einfacherem Docker-Image
  mailserver:
    image: namshi/smtp
    container_name: ticketumfrage_mailserver
    ports:
      - "1025:25"
    networks:
      - ticketumfrage_network
    restart: unless-stopped

# Docker Networks
networks:
  ticketumfrage_network:
    driver: bridge

# Docker Volumes
volumes:
  dbdata:
    driver: local